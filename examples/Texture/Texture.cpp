#include "TinyGLES.h"
#include "TinyPNG.h"

#include <iostream>
#include <assert.h>

static uint32_t LoadTexture(tinygles::GLES *GL,const char* pFilename)
{
        // Load in a test texture
    uint32_t textureHandle = 0;
    tinypng::Loader png(false);
    if( png.LoadFromFile(pFilename) )
    {
        if( png.GetHasAlpha() )
        {
            std::vector<uint8_t> RGBA;
            png.GetRGBA(RGBA);
            textureHandle = GL->CreateTexture(png.GetWidth(),png.GetHeight(),RGBA.data(),tinygles::TextureFormat::FORMAT_RGBA);
        }
        else
        {
            std::vector<uint8_t> RGB;
            png.GetRGB(RGB);
            textureHandle = GL->CreateTexture(png.GetWidth(),png.GetHeight(),RGB.data(),tinygles::TextureFormat::FORMAT_RGB);
        }
    }
    assert(textureHandle);

    return textureHandle;
}

struct ABall
{
    int ballx = rand()%500;
    int bally = rand()%500;
    int vx = 1 + (rand()%10);
    int vy = 1 + (rand()%10);

    void Update(tinygles::GLES *GL,uint32_t ballTexture)
    {
        ballx += vx;
        if( ballx > GL->GetWidth()-64)
        {
            vx = -(1+(rand()%7));
        }
        else if( ballx < 0 )
        {
            vx = (1+(rand()%7));
        }

        bally += vy;
        if( bally > GL->GetHeight()-64 )
        {
            vy = -(1+(rand()%7));
        }
        else if( bally < 0 )
        {
            vy = (1+(rand()%7));
        }

        GL->FillRectangle(ballx,bally,ballx+64,bally+64,ballTexture);
    }
};

int main(int argc, char *argv[])
{
// Say hello to the world!
    std::cout << "Hello world, a skeleton app generated by appbuild.\n";

// Display the constants defined by app build. \n";
    std::cout << "Application Version " << APP_VERSION << '\n';
    std::cout << "Build date and time " << APP_BUILD_DATE_TIME << '\n';
    std::cout << "Build date " << APP_BUILD_DATE << '\n';
    std::cout << "Build time " << APP_BUILD_TIME << '\n';

    tinygles::GLES* GL = new tinygles::GLES(true);

    // Load in a test texture
    uint32_t create = LoadTexture(GL,"crate.png");
    uint32_t plant = LoadTexture(GL,"plant.png");
    uint32_t debug1 = LoadTexture(GL,"debug.png");
    uint32_t debug2 = LoadTexture(GL,"debug2.png");
    uint32_t ball = LoadTexture(GL,"foot-ball.png");

    std::array<ABall,20> balls;

    int anim = 0;
    std::cout << "Starting render loop\n";
    while( GL->BeginFrame() )
    {
        anim++;

        GL->FillRectangle(0,0,GL->GetWidth(),GL->GetHeight(),GL->GetDiagnosticsTexture());

        GL->FillRoundedRectangle(50,50,950,550,100,55,20,155);
        GL->DrawRoundedRectangle(50,50,950,550,100,255,255,255);
    
        for( auto& b : balls )
        {
            b.Update(GL,ball);
        }

        GL->FillRectangle(100,100,200,200,create);
        GL->FillRectangle(300,100,400,200,plant);

        GL->FillRectangle(100,300,300,500,debug1);
        GL->FillRectangle(400,300,600,500,debug2);

        GL->EndFrame();
    }

    delete GL;

    std::cout << "Exit...";

    return EXIT_SUCCESS;
}
